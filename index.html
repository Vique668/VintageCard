
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–í–∏–Ω—Ç–∞–∂–Ω–∞—è –æ—Ç–∫—Ä—ã—Ç–∫–∞ ‚Äî –° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #fdfaf6; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
        }
        .font-vintage { font-family: 'Marck Script', cursive; }
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        @keyframes snowfall {
            0% { transform: translateY(-10px) rotate(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            pointer-events: none;
            z-index: 0;
            animation: snowfall linear infinite;
        }
        .developing-photo {
            filter: sepia(1) blur(5px) contrast(0.5);
            animation: develop 15s forwards cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes develop {
            0% { filter: sepia(1) blur(10px) contrast(0.2); opacity: 0.3; }
            100% { filter: sepia(0) blur(0) contrast(1); opacity: 1; }
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@1.34.0",
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI } from "@google/genai";

        const Header = () => (
            <header className="relative z-10 py-10 text-center">
                <div className="container mx-auto px-4">
                    <div className="inline-block relative">
                        <span className="absolute -left-12 top-0 text-4xl animate-bounce">‚ùÑÔ∏è</span>
                        <h1 className="text-5xl md:text-7xl font-vintage text-red-700 drop-shadow-xl mb-2">
                            –° –ù–æ–≤—ã–º –≥–æ–¥–æ–º!
                        </h1>
                        <span className="absolute -right-12 top-0 text-4xl animate-bounce delay-100">üå≤</span>
                    </div>
                    <p className="text-slate-500 text-[10px] font-bold tracking-[0.5em] uppercase mt-4">
                        –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –≤–∏–Ω—Ç–∞–∂–Ω—ã—Ö –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π
                    </p>
                </div>
            </header>
        );

        const App = () => {
            const [images, setImages] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);

            const onFileChange = (e) => {
                const files = Array.from(e.target.files || []);
                const remainingSlots = 3 - images.length;
                files.slice(0, remainingSlots).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setImages(prev => [...prev, ev.target.result]);
                        setError(null);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const generate = async () => {
                if (images.length === 0) return;
                
                // Get key safely from process.env (Vite will inject it if configured)
                let apiKey = "";
                try {
                    apiKey = process.env.API_KEY;
                } catch (e) {
                    console.error("Process is not defined, check your bundler settings.");
                }

                if (!apiKey || apiKey === "") {
                    setError("API-–∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. –ï—Å–ª–∏ –≤—ã –Ω–∞ GitHub, –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ Settings -> Secrets -> Actions –ø–æ–¥ –∏–º–µ–Ω–µ–º API_KEY.");
                    return;
                }

                setIsGenerating(true);
                setError(null);

                try {
                    const ai = new GoogleGenAI({ apiKey });
                    
                    const imageParts = images.map(url => ({
                        inlineData: {
                            data: url.split(',')[1],
                            mimeType: url.split(',')[0].split(':')[1].split(';')[0]
                        }
                    }));

                    const prompt = `Create a masterpiece Soviet New Year greeting card from the late 1960s. 
                    The scene MUST feature the EXACT people from the uploaded photos. 
                    They should be transformed into beautiful gouache-style illustrations while maintaining strict facial likeness. 
                    The characters are dressed in vintage winter clothing: elegant woolen coats, stylish fur hats (ushankas), and colorful scarves. 
                    Background: A magical, snowy evening forest with a large, glowing, decorated fir tree. 
                    Nostalgic, warm, and festive atmosphere. High-quality artistic texture similar to classic hand-painted postcards. 
                    No text or letters inside the image itself.`;

                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash-image',
                        contents: { parts: [...imageParts, { text: prompt }] },
                        config: { 
                            imageConfig: { 
                                aspectRatio: "9:16"
                            } 
                        }
                    });

                    let base64 = "";
                    const parts = response.candidates?.[0]?.content?.parts || [];
                    for (const p of parts) {
                        if (p.inlineData) {
                            base64 = `data:image/png;base64,${p.inlineData.data}`;
                            break;
                        }
                    }

                    if (base64) {
                        const finalCard = await applyPostcardEffects(base64);
                        setResult(finalCard);
                    } else {
                        throw new Error("–ò–ò –Ω–µ —Å–º–æ–≥ —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏.");
                    }
                } catch (err) {
                    console.error("Generation error:", err);
                    setError("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã –≤–∞—à–µ–≥–æ API –∫–ª—é—á–∞ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub Secrets.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const applyPostcardEffects = (base64) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);

                        const fontSize = Math.floor(canvas.width * 0.12);
                        ctx.font = `${fontSize}px 'Marck Script'`;
                        ctx.textAlign = 'center';
                        const text = "–° –ù–æ–≤—ã–º –≥–æ–¥–æ–º!";
                        const x = canvas.width / 2;
                        const y = canvas.height * 0.15;

                        ctx.shadowColor = 'rgba(0,0,0,0.6)';
                        ctx.shadowBlur = 15;
                        ctx.shadowOffsetX = 3;
                        ctx.shadowOffsetY = 3;

                        ctx.strokeStyle = '#7b0000';
                        ctx.lineWidth = fontSize * 0.08;
                        ctx.strokeText(text, x, y);

                        const goldGrad = ctx.createLinearGradient(0, y - fontSize, 0, y);
                        goldGrad.addColorStop(0, '#fffbe6');
                        goldGrad.addColorStop(0.5, '#ffcc33');
                        goldGrad.addColorStop(1, '#e6ac00');
                        ctx.fillStyle = goldGrad;
                        ctx.shadowColor = 'transparent';
                        ctx.fillText(text, x, y);

                        // Old paper texture overlay
                        ctx.globalCompositeOperation = 'multiply';
                        ctx.globalAlpha = 0.08;
                        for (let i = 0; i < 5000; i++) {
                            const rx = Math.random() * canvas.width;
                            const ry = Math.random() * canvas.height;
                            ctx.fillStyle = i % 2 === 0 ? '#000' : '#444';
                            ctx.fillRect(rx, ry, 1, 1);
                        }

                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = base64;
                });
            };

            const reset = () => {
                setResult(null);
                setImages([]);
                setError(null);
            };

            return (
                <div className="min-h-screen flex flex-col relative">
                    <Header />
                    
                    <main className="container mx-auto px-4 pb-20 max-w-5xl flex-grow z-10">
                        {result ? (
                            <div className="max-w-lg mx-auto animate-in fade-in zoom-in duration-700">
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-2xl border-8 border-white ring-1 ring-slate-200">
                                    <img src={result} className="w-full h-auto rounded-xl shadow-inner developing-photo" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç" />
                                    <div className="mt-8 flex flex-col sm:flex-row gap-4">
                                        <button onClick={() => {
                                            const a = document.createElement('a');
                                            a.href = result;
                                            a.download = `new_year_${Date.now()}.png`;
                                            a.click();
                                        }} className="flex-1 py-4 bg-red-700 text-white rounded-2xl font-bold text-lg hover:bg-red-800 shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2">
                                            üíæ –°–∫–∞—á–∞—Ç—å
                                        </button>
                                        <button onClick={reset} className="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold text-lg hover:bg-slate-200 active:scale-95 transition-all">
                                            üîÑ –ï—â—ë –æ–¥–Ω—É?
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="grid lg:grid-cols-2 gap-10 items-start">
                                <div className="glass-card p-10 rounded-[3rem] shadow-2xl border-white/50">
                                    <h2 className="text-3xl font-extrabold text-slate-800 mb-6">–°–æ–∑–¥–∞—Ç—å —á—É–¥–æ ‚ú®</h2>
                                    <p className="text-slate-600 leading-relaxed mb-10">
                                        –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ 3 —Ñ–æ—Ç–æ. –ú—ã –Ω–∞—Ä–∏—Å—É–µ–º –≤–∞—Å –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–µ–π —Å–æ–≤–µ—Ç—Å–∫–æ–π –æ—Ç–∫—Ä—ã—Ç–∫–µ 60-—Ö –≥–æ–¥–æ–≤.
                                    </p>

                                    <div 
                                        onClick={() => fileInputRef.current?.click()}
                                        className="relative group w-full border-4 border-dashed border-red-100 rounded-[2.5rem] p-16 text-center cursor-pointer hover:border-red-400 hover:bg-red-50/50 transition-all shadow-inner"
                                    >
                                        <div className="text-7xl mb-6 group-hover:scale-110 transition-transform">üì∏</div>
                                        <p className="font-bold text-slate-700 text-lg">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</p>
                                        <input type="file" ref={fileInputRef} onChange={onFileChange} multiple accept="image/*" className="hidden" />
                                    </div>

                                    {images.length > 0 && (
                                        <div className="mt-10 flex flex-wrap gap-4 justify-center">
                                            {images.map((img, i) => (
                                                <div key={i} className="relative w-24 h-24 group">
                                                    <img src={img} className="w-full h-full object-cover rounded-2xl ring-4 ring-white shadow-xl group-hover:brightness-75 transition-all" />
                                                    <button onClick={() => setImages(prev => prev.filter((_, idx) => idx !== i))} className="absolute -top-3 -right-3 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg hover:bg-red-600 transition-all">√ó</button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="h-full">
                                    <div className="glass-card p-12 rounded-[3rem] shadow-2xl min-h-[500px] flex flex-col items-center justify-center text-center border-white/50">
                                        {isGenerating ? (
                                            <div className="space-y-12 w-full animate-pulse">
                                                <div className="relative w-40 h-40 mx-auto">
                                                    <div className="absolute inset-0 border-[12px] border-slate-100 rounded-full"></div>
                                                    <div className="absolute inset-0 border-[12px] border-t-red-700 rounded-full animate-spin"></div>
                                                    <div className="absolute inset-0 flex items-center justify-center text-5xl">üé®</div>
                                                </div>
                                                <div className="space-y-4">
                                                    <p className="text-3xl font-black text-slate-800">–•—É–¥–æ–∂–Ω–∏–∫ —Ä–∏—Å—É–µ—Ç...</p>
                                                    <p className="text-sm text-slate-400 italic max-w-xs mx-auto leading-relaxed">
                                                        –ì–æ—Ç–æ–≤–∏–º –∫—Ä–∞—Å–∫–∏, —Å–Ω–µ–≥ –∏ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.
                                                    </p>
                                                </div>
                                            </div>
                                        ) : images.length > 0 ? (
                                            <div className="w-full space-y-8">
                                                <button onClick={generate} className="group w-full py-10 bg-red-700 text-white rounded-[2.5rem] font-black text-4xl hover:bg-red-800 hover:scale-[1.03] transition-all shadow-2xl shadow-red-200 active:scale-95 flex items-center justify-center gap-6">
                                                    <span>–°–û–ó–î–ê–¢–¨</span>
                                                    <span className="group-hover:rotate-12 transition-transform">üéÑ</span>
                                                </button>
                                                <p className="text-[10px] text-slate-300 uppercase tracking-[0.4em] font-bold">Vintage Engine v2.5</p>
                                            </div>
                                        ) : (
                                            <div className="opacity-10 flex flex-col items-center select-none">
                                                <div className="text-[12rem] mb-4">üéÖ</div>
                                                <p className="text-2xl font-bold text-slate-500 uppercase tracking-widest">–ñ–¥—ë–º –≤–∞—à–∏ —Ñ–æ—Ç–æ</p>
                                            </div>
                                        )}
                                        
                                        {error && (
                                            <div className="mt-10 p-6 bg-red-50 text-red-800 rounded-3xl text-sm font-bold border-2 border-red-100 w-full animate-bounce">
                                                ‚ö†Ô∏è {error}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="py-12 text-center text-slate-400 text-xs bg-white/30 border-t border-slate-100 z-10 backdrop-blur-sm">
                        <p className="font-bold mb-2 uppercase tracking-tighter">–°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –∫ —Ä–µ—Ç—Ä–æ ‚Ä¢ 2024</p>
                        <p className="opacity-40 italic">Facial Likeness Optimization Enabled</p>
                    </footer>

                    {[...Array(25)].map((_, i) => (
                        <div key={i} className="snowflake" style={{
                            left: `${Math.random() * 100}%`,
                            animationDuration: `${Math.random() * 8 + 5}s`,
                            animationDelay: `${Math.random() * 5}s`,
                            fontSize: `${Math.random() * 14 + 6}px`
                        }}>‚ùÑ</div>
                    ))}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
