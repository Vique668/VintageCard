
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–í–∏–Ω—Ç–∞–∂–Ω–∞—è –æ—Ç–∫—Ä—ã—Ç–∫–∞ ‚Äî –° –ù–æ–≤—ã–º –ì–æ–¥–æ–º!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Marck+Script&family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #fdfaf6; 
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
        }
        .font-vintage { font-family: 'Marck Script', cursive; }
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        @keyframes snowfall {
            0% { transform: translateY(-10px) rotate(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            pointer-events: none;
            z-index: 0;
            animation: snowfall linear infinite;
        }
    </style>
    <script>
        // Ensure process.env.API_KEY is available and not overwritten if already set
        window.process = window.process || { env: {} };
        if (!window.process.env.API_KEY) {
            window.process.env.API_KEY = ""; 
        }
    </script>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@1.34.0",
    "react": "https://esm.sh/react@19.0.0",
    "react-dom": "https://esm.sh/react-dom@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body className="overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { GoogleGenAI } from "@google/genai";

        // --- Components ---

        const Header = () => (
            <header className="relative z-10 py-10 text-center">
                <div className="container mx-auto px-4">
                    <div className="inline-block relative">
                        <span className="absolute -left-12 top-0 text-4xl animate-bounce">‚ùÑÔ∏è</span>
                        <h1 className="text-5xl md:text-7xl font-vintage text-red-700 drop-shadow-xl mb-2">
                            –° –ù–æ–≤—ã–º –≥–æ–¥–æ–º!
                        </h1>
                        <span className="absolute -right-12 top-0 text-4xl animate-bounce delay-100">üå≤</span>
                    </div>
                    <p className="text-slate-500 text-[10px] font-bold tracking-[0.5em] uppercase mt-4">
                        –ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –≤–∏–Ω—Ç–∞–∂–Ω—ã—Ö –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π
                    </p>
                </div>
            </header>
        );

        const App = () => {
            const [images, setImages] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);

            const onFileChange = (e) => {
                const files = Array.from(e.target.files || []);
                const remainingSlots = 3 - images.length;
                const filesToProcess = files.slice(0, remainingSlots);

                filesToProcess.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setImages(prev => [...prev, ev.target.result]);
                        setError(null);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const generate = async () => {
                if (images.length === 0) return;
                setIsGenerating(true);
                setError(null);

                try {
                    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                    
                    const imageParts = images.map(url => ({
                        inlineData: {
                            data: url.split(',')[1],
                            mimeType: url.split(',')[0].split(':')[1].split(';')[0]
                        }
                    }));

                    const prompt = `Create a high-quality vintage Soviet New Year greeting card (1960s style illustration). 
                    The card must feature ONLY the specific people from the provided photos. 
                    Style: Painterly, gouache-like texture, warm nostalgic colors (reds, golds, deep greens). 
                    Characters should be wearing vintage winter outfits (fur hats, wool coats, stylish scarves). 
                    Background: A magical snowy winter forest with a decorated fir tree and glowing lanterns. 
                    Important: Maintain high facial likeness to the people in the photos. 
                    Do not include any text in the generated image itself. 
                    Leave the top 15% of the frame slightly clearer for an overlay.`;

                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash-image',
                        contents: { parts: [...imageParts, { text: prompt }] },
                        config: { 
                            imageConfig: { 
                                aspectRatio: "9:16" 
                            } 
                        }
                    });

                    let base64 = "";
                    const parts = response.candidates?.[0]?.content?.parts || [];
                    for (const p of parts) {
                        if (p.inlineData) {
                            base64 = `data:image/png;base64,${p.inlineData.data}`;
                            break;
                        }
                    }

                    if (base64) {
                        const finalCard = await applyPostcardEffects(base64);
                        setResult(finalCard);
                    } else {
                        throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ç–æ.");
                    }
                } catch (err) {
                    console.error(err);
                    setError(err.message || "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ò–ò");
                } finally {
                    setIsGenerating(false);
                }
            };

            const applyPostcardEffects = (base64) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        // Draw generated image
                        ctx.drawImage(img, 0, 0);

                        // Add vintage vignette
                        const gradient = ctx.createRadialGradient(
                            canvas.width / 2, canvas.height / 2, 0,
                            canvas.width / 2, canvas.height / 2, canvas.height / 1.2
                        );
                        gradient.addColorStop(0, 'rgba(0,0,0,0)');
                        gradient.addColorStop(1, 'rgba(0,0,0,0.3)');
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        // Add "Happy New Year" text
                        const fontSize = Math.floor(canvas.width * 0.13);
                        ctx.font = `${fontSize}px 'Marck Script'`;
                        ctx.textAlign = 'center';
                        const text = "–° –ù–æ–≤—ã–º –≥–æ–¥–æ–º!";
                        const x = canvas.width / 2;
                        const y = canvas.height * 0.15;

                        // Text shadow
                        ctx.shadowColor = 'rgba(0,0,0,0.4)';
                        ctx.shadowBlur = 15;
                        ctx.shadowOffsetX = 4;
                        ctx.shadowOffsetY = 4;

                        // Text stroke
                        ctx.strokeStyle = '#6a040f';
                        ctx.lineWidth = fontSize * 0.08;
                        ctx.strokeText(text, x, y);

                        // Text fill (gold gradient)
                        const goldGrad = ctx.createLinearGradient(0, y - fontSize, 0, y);
                        goldGrad.addColorStop(0, '#fff4cc');
                        goldGrad.addColorStop(0.5, '#ffd700');
                        goldGrad.addColorStop(1, '#daa520');
                        ctx.fillStyle = goldGrad;
                        ctx.shadowColor = 'transparent';
                        ctx.fillText(text, x, y);

                        // Add paper texture overlay
                        ctx.globalCompositeOperation = 'overlay';
                        ctx.globalAlpha = 0.15;
                        // Using simple noise since external textures can be blocked
                        for (let i = 0; i < 1000; i++) {
                            const rx = Math.random() * canvas.width;
                            const ry = Math.random() * canvas.height;
                            ctx.fillStyle = i % 2 === 0 ? '#fff' : '#000';
                            ctx.fillRect(rx, ry, 1, 1);
                        }

                        resolve(canvas.toDataURL('image/png'));
                    };
                    img.src = base64;
                });
            };

            const reset = () => {
                setResult(null);
                setImages([]);
                setError(null);
            };

            return (
                <div className="min-h-screen flex flex-col relative">
                    <Header />
                    
                    <main className="container mx-auto px-4 pb-20 max-w-5xl flex-grow z-10">
                        {result ? (
                            <div className="max-w-lg mx-auto transform transition-all animate-in fade-in zoom-in duration-500">
                                <div className="bg-white p-6 rounded-[2rem] shadow-2xl border-8 border-white">
                                    <img src={result} className="w-full h-auto rounded-xl shadow-inner" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç" />
                                    <div className="mt-8 flex flex-col sm:flex-row gap-4">
                                        <button 
                                            onClick={() => {
                                                const a = document.createElement('a');
                                                a.href = result;
                                                a.download = `new_year_card_${Date.now()}.png`;
                                                a.click();
                                            }}
                                            className="flex-1 py-4 bg-red-600 text-white rounded-2xl font-bold text-lg hover:bg-red-700 transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2"
                                        >
                                            üíæ –°–∫–∞—á–∞—Ç—å
                                        </button>
                                        <button 
                                            onClick={reset}
                                            className="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold text-lg hover:bg-slate-200 transition-all active:scale-95"
                                        >
                                            üîÑ –ï—â–µ —Ä–∞–∑
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="grid lg:grid-cols-2 gap-10 items-start">
                                <div className="glass-card p-10 rounded-[3rem] shadow-2xl">
                                    <h2 className="text-3xl font-extrabold text-slate-800 mb-6">–°–æ–∑–¥–∞–π—Ç–µ —á—É–¥–æ ‚ú®</h2>
                                    <p className="text-slate-600 leading-relaxed mb-10">
                                        –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ 3 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π. –ù–∞—à –ò–ò –±–µ—Ä–µ–∂–Ω–æ –≤–æ—Å—Å–æ–∑–¥–∞—Å—Ç –≤–∞—à–∏ –ª–∏—Ü–∞ –≤ —Å—Ç–∏–ª–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π —Å–æ–≤–µ—Ç—Å–∫–æ–π –æ—Ç–∫—Ä—ã—Ç–∫–∏.
                                    </p>

                                    <div 
                                        onClick={() => fileInputRef.current?.click()}
                                        className="relative overflow-hidden group w-full border-4 border-dashed border-red-100 rounded-[2.5rem] p-16 text-center cursor-pointer hover:border-red-400 hover:bg-red-50/50 transition-all"
                                    >
                                        <div className="text-7xl mb-6 group-hover:scale-110 transition-transform">üì∏</div>
                                        <p className="font-bold text-slate-700 text-lg">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</p>
                                        <p className="text-xs text-slate-400 mt-2">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ—Ä—Ç—Ä–µ—Ç–Ω—ã–µ —Ñ–æ—Ç–æ</p>
                                        <input 
                                            type="file" 
                                            ref={fileInputRef} 
                                            onChange={onFileChange} 
                                            multiple 
                                            accept="image/*" 
                                            className="hidden" 
                                        />
                                    </div>

                                    {images.length > 0 && (
                                        <div className="mt-10 flex flex-wrap gap-4 justify-center">
                                            {images.map((img, i) => (
                                                <div key={i} className="relative group w-24 h-24">
                                                    <img src={img} className="w-full h-full object-cover rounded-2xl ring-4 ring-white shadow-xl" />
                                                    <button 
                                                        onClick={() => setImages(prev => prev.filter((_, idx) => idx !== i))}
                                                        className="absolute -top-3 -right-3 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center shadow-lg hover:bg-red-600 transition-all"
                                                    >
                                                        √ó
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                <div className="h-full">
                                    <div className="glass-card p-12 rounded-[3rem] shadow-2xl min-h-[500px] flex flex-col items-center justify-center text-center">
                                        {isGenerating ? (
                                            <div className="space-y-10 w-full animate-in fade-in duration-1000">
                                                <div className="relative w-32 h-32 mx-auto">
                                                    <div className="absolute inset-0 border-8 border-slate-100 rounded-full"></div>
                                                    <div className="absolute inset-0 border-8 border-t-red-600 rounded-full animate-spin"></div>
                                                    <div className="absolute inset-0 flex items-center justify-center text-4xl">ü™Ñ</div>
                                                </div>
                                                <div>
                                                    <p className="text-3xl font-black text-slate-800">–ú–∞–≥–∏—è –ò–ò...</p>
                                                    <p className="text-sm text-slate-400 mt-4 italic max-w-xs mx-auto">
                                                        –ü—Ä–æ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–∏–Ω—Ç–∞–∂–Ω—ã–µ –∫–æ—Å—Ç—é–º—ã –∏ —Å–Ω–µ–∂–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É. –≠—Ç–æ –∑–∞–π–º–µ—Ç –æ–∫–æ–ª–æ 15 —Å–µ–∫—É–Ω–¥.
                                                    </p>
                                                </div>
                                            </div>
                                        ) : images.length > 0 ? (
                                            <div className="w-full space-y-10 scale-in-center">
                                                <div className="inline-block px-8 py-3 bg-green-50 text-green-700 rounded-full font-bold border border-green-100">
                                                    ‚úì –ì–æ—Ç–æ–≤–æ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ({images.length}/3)
                                                </div>
                                                <button 
                                                    onClick={generate} 
                                                    className="w-full py-8 bg-red-600 text-white rounded-[2.5rem] font-black text-3xl hover:bg-red-700 hover:scale-[1.02] transition-all shadow-2xl shadow-red-200 active:scale-95 flex items-center justify-center gap-4"
                                                >
                                                    <span>–°–û–ó–î–ê–¢–¨ –ú–ê–ì–ò–Æ</span>
                                                    <span>‚ú®</span>
                                                </button>
                                                <p className="text-[10px] text-slate-300 uppercase tracking-widest font-bold">Powered by Gemini 2.5 Flash</p>
                                            </div>
                                        ) : (
                                            <div className="opacity-20 flex flex-col items-center">
                                                <div className="text-[10rem] mb-4">üéÑ</div>
                                                <p className="text-2xl font-bold text-slate-400">–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</p>
                                            </div>
                                        )}
                                        
                                        {error && (
                                            <div className="mt-10 p-5 bg-red-50 text-red-600 rounded-3xl text-sm font-bold border border-red-100 w-full animate-shake">
                                                ‚ö†Ô∏è {error}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="py-12 text-center text-slate-400 text-xs bg-white/50 border-t border-slate-100 z-10">
                        <p className="font-bold mb-2">¬© 2024 –†–µ—Ç—Ä–æ-—Ñ–æ—Ç–æ–º–∞—Å—Ç–µ—Ä—Å–∫–∞—è</p>
                        <p className="opacity-50">–°–æ–∑–¥–∞–Ω–æ –¥–ª—è —Ä–∞–¥–æ—Å—Ç–∏ –∏ –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</p>
                    </footer>

                    {/* Background snow particles */}
                    {[...Array(20)].map((_, i) => (
                        <div 
                            key={i} 
                            className="snowflake"
                            style={{
                                left: `${Math.random() * 100}%`,
                                animationDuration: `${Math.random() * 5 + 5}s`,
                                animationDelay: `${Math.random() * 5}s`,
                                fontSize: `${Math.random() * 10 + 10}px`
                            }}
                        >
                            ‚Ä¢
                        </div>
                    ))}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
